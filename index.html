<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarTracker - Control de Kilometraje</title>
    <meta name="description" content="CarTracker: registra vehículos, controla kilometraje y recibe alertas de mantenimiento cada 5000 km. 100% localStorage, sin servidor.">
    <meta name="keywords" content="kilometraje, mantenimiento, autos, vehiculos, tracker, kilometros, car tracker">
    <meta name="author" content="CarTracker">
    <meta name="theme-color" content="#f87171">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CarTracker - Control de Kilometraje">
    <meta property="og:description" content="Registra vehículos, controla kilometraje y recibe alertas de mantenimiento cada 5000 km.">
    <meta property="og:url" content="https://car-kilometer.pages.dev/">
    <meta property="og:image" content="https://car-kilometer.pages.dev/favicon.svg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CarTracker - Control de Kilometraje">
    <meta name="twitter:description" content="Registra vehículos, controla kilometraje y recibe alertas de mantenimiento cada 5000 km.">
    <meta name="twitter:image" content="https://car-kilometer.pages.dev/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="app-style">
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f5f2;
            color: #333;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #f87171;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #ef4444;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #94a3b8;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #64748b;
            transform: translateY(-2px);
        }
        .maintenance-alert {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .license-plate {
            background-color: #fff;
            border: 2px solid #000;
            font-weight: bold;
            letter-spacing: 1px;
            display: inline-block;
            padding: 4px 10px;
        }
        .input-error {
            border-color: #ef4444;
        }
        .input-warning {
            border-color: #f59e0b;
        }
        .warning-message {
            color: #92400e;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .maintenance-badge { background-color: #fef3c7; color: #92400e; }
        .maintenance-icon { color: #f59e0b; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <div class="inline-block p-2 bg-red-500 text-white rounded-lg mb-4">
                <i class="fas fa-car-side text-3xl"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">CarTracker</h1>
            <p class="text-gray-600">Controla el mantenimiento de tu vehículo con facilidad</p>
            <div id="session-info" class="mt-3 text-sm text-gray-500 hidden"></div>
        </header>

        <div id="vehicle-selector" class="card bg-white p-6 md:p-8 mb-8 hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Mis Vehículos</h2>
                <button id="add-vehicle-btn" class="btn-primary text-white py-2 px-4 rounded-lg text-sm mt-2 md:mt-0">
                    <i class="fas fa-plus mr-2"></i> Agregar Vehículo
                </button>
            </div>
            <div id="vehicles-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-gray-500 text-center py-4 col-span-2">No hay vehículos registrados aún</p>
            </div>
        </div>

        <div id="registration-form" class="card bg-white p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Agregar Nuevo Vehículo</h2>
            <form id="vehicle-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del propietario</label>
                    <input type="text" id="name" name="name" class="w-full px-4 py-2 border rounded-lg bg-gray-100" placeholder="Se toma de tu perfil" disabled>
                    <p class="text-gray-500 text-xs mt-1">Se usa el nombre de tu sesión. Edita tu nombre al cerrar sesión y registrarte de nuevo.</p>
                </div>
                <div>
                    <label for="idNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Cédula</label>
                    <input type="text" id="idNumber" name="idNumber" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    <p class="text-red-500 text-sm mt-1 hidden error-message" id="idNumber-error">La cédula es requerida</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 mb-1">Modelo del Vehículo</label>
                        <input type="text" id="model" name="model" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                        <p class="text-red-500 text-sm mt-1 hidden error-message" id="model-error">El modelo es requerido</p>
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Año</label>
                        <input type="number" id="year" name="year" min="1900" max="2025" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                        <p class="text-red-500 text-sm mt-1 hidden error-message" id="year-error">Ingrese un año válido</p>
                    </div>
                </div>
                <div>
                    <label for="licensePlate" class="block text-sm font-medium text-gray-700 mb-1">Placa (letras y números en mayúscula)</label>
                    <input type="text" id="licensePlate" name="licensePlate" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500 uppercase" required maxlength="8">
                    <p class="text-red-500 text-sm mt-1 hidden error-message" id="licensePlate-error">Ingrese una placa válida (sólo letras y números)</p>
                </div>
                <div>
                    <label for="initialMileage" class="block text-sm font-medium text-gray-700 mb-1">Kilometraje Inicial</label>
                    <input type="number" id="initialMileage" name="initialMileage" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    <p class="text-red-500 text-sm mt-1 hidden error-message" id="initialMileage-error">Ingrese un kilometraje válido</p>
                </div>
                <div class="pt-2">
                    <button type="submit" class="w-full btn-primary text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                        <span id="submit-text">Guardar y Continuar</span>
                        <span id="loading-spinner" class="hidden ml-2">
                            <i class="fas fa-circle-notch spinner"></i>
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <div id="dashboard" class="hidden">
            <div class="card bg-white p-6 mb-6 slide-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="dashboard-name"></h2>
                        <div class="flex items-center flex-wrap gap-2 mt-2">
                            <span class="text-gray-600" id="dashboard-model-year"></span>
                            <span class="license-plate" id="dashboard-license-plate"></span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <div class="flex gap-2">
                            <button id="new-appointment-btn" class="btn-primary text-white py-2 px-4 rounded-lg text-sm">
                                <i class="fas fa-calendar-plus mr-2"></i> Nueva cita
                            </button>
                            <button id="settings-btn" class="btn-secondary text-white py-2 px-4 rounded-lg text-sm">
                                <i class="fas fa-cog mr-2"></i> Configuración
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-white p-6 mb-6 slide-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Kilometraje Actual</h3>
                <div class="bg-gray-100 p-4 rounded-lg mb-6">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">Lectura Actual:</span>
                        <span class="text-2xl font-bold text-gray-800" id="current-mileage">0 km</span>
                    </div>
                </div>

                <form id="new-mileage-form" class="space-y-4">
                    <div>
                        <label for="newMileage" class="block text-sm font-medium text-gray-700 mb-1">Nueva Lectura de Kilometraje</label>
                        <input type="number" id="newMileage" name="newMileage" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                        <p class="text-red-500 text-sm mt-1 hidden" id="newMileage-error">El kilometraje debe ser mayor que el anterior</p>
                        <p class="warning-message text-sm mt-1 hidden" id="newMileage-warning">Kilometraje inferior al último, pero será guardado</p>
                    </div>

                    <button type="submit" class="w-full btn-primary text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                        <span>Actualizar Kilometraje</span>
                        <span id="update-spinner" class="hidden ml-2">
                            <i class="fas fa-circle-notch spinner"></i>
                        </span>
                    </button>
                </form>
            </div>

            <div class="card bg-white p-6 slide-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Historial de Mantenimiento</h3>
                <div id="maintenance-history" class="max-h-80 overflow-y-auto space-y-3 p-1">
                    <p class="text-gray-500 text-center py-4">No hay registros de mantenimiento aún</p>
                </div>
            </div>

            <div class="card bg-white p-6 mt-6 slide-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Citas de Mantenimiento</h3>
                    <button id="new-appointment-btn-secondary" class="btn-primary text-white py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-calendar-plus mr-2"></i> Nueva cita
                    </button>
                </div>
                <div id="appointments-list" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">No hay citas programadas</p>
                </div>
            </div>
        </div>

        <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg max-w-md w-full p-6 slide-in mx-4">
                <div class="text-center">
                    <div class="inline-block p-3 bg-yellow-100 rounded-full mb-4">
                        <i class="fas fa-wrench text-yellow-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">¡Alerta de Mantenimiento!</h3>
                    <p class="text-gray-600 mb-6" id="maintenance-message">
                        Tu vehículo ha alcanzado los 5000 km desde el último mantenimiento.
                        Es recomendable llevarlo al taller para revisión.
                    </p>
                    <button id="close-modal" class="btn-primary text-white py-2 px-6 rounded-lg">
                        Entendido
                    </button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg max-w-md w-full p-6 slide-in mx-4">
                <h3 class="text-xl font-bold mb-4">Configuración</h3>
                <div class="space-y-4">
                    <div class="border-t border-b py-4">
                        <button id="delete-vehicle" class="flex items-center text-red-500 hover:text-red-700 mb-3">
                            <i class="fas fa-trash mr-2"></i> Eliminar este vehículo
                        </button>
                        <button id="reset-app" class="flex items-center text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt mr-2"></i> Reiniciar aplicación
                        </button>
                        <p class="text-sm text-gray-500 mt-1">Esto borrará todos los datos guardados</p>
                    </div>
                    <div class="border-b pb-4">
                        <button id="logout-btn" class="flex items-center text-gray-700 hover:text-gray-900">
                            <i class="fas fa-right-from-bracket mr-2"></i> Cerrar sesión
                        </button>
                    </div>
                    <div class="text-right">
                        <button id="close-settings" class="btn-secondary text-white py-2 px-4 rounded-lg text-sm">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg max-w-md w-full p-6 slide-in mx-4">
                <h3 class="text-xl font-bold mb-4 text-center">Bienvenido a CarTracker</h3>
                <div class="flex justify-center gap-2 mb-4">
                    <button id="tab-login" class="px-3 py-2 rounded bg-gray-200 text-sm font-medium">Iniciar sesión</button>
                    <button id="tab-register" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">Crear cuenta</button>
                </div>
                <form id="login-form" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="login-email">Email</label>
                        <input id="login-email" type="email" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="login-password">Contraseña</label>
                        <input id="login-password" type="password" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm hidden">Credenciales inválidas</p>
                    <button type="submit" class="w-full btn-primary text-white py-2 px-4 rounded-lg">Entrar</button>
                </form>
                <form id="register-form" class="space-y-3 hidden mt-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="reg-name">Nombre</label>
                        <input id="reg-name" type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="reg-email">Email</label>
                        <input id="reg-email" type="email" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="reg-password">Contraseña (mín. 6)</label>
                        <input id="reg-password" type="password" minlength="6" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <p id="register-error" class="text-red-500 text-sm hidden">El email ya está registrado</p>
                    <button type="submit" class="w-full btn-primary text-white py-2 px-4 rounded-lg">Crear cuenta</button>
                </form>
            </div>
        </div>

        <!-- Appointment Modal -->
        <div id="appointment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg max-w-md w-full p-6 slide-in mx-4">
                <h3 class="text-xl font-bold mb-4">Programar cita de mantenimiento</h3>
                <form id="appointment-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="appt-date">Fecha</label>
                        <input type="date" id="appt-date" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="appt-time">Hora</label>
                        <input type="time" id="appt-time" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="appt-workshop">Taller</label>
                        <input type="text" id="appt-workshop" list="workshops-list" placeholder="Selecciona taller" value="Próximamente" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500" required>
                        <datalist id="workshops-list">
                            <option value="Próximamente"></option>
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="appt-notes">Notas</label>
                        <textarea id="appt-notes" rows="3" placeholder="Descripción del servicio" class="w-full px-4 py-2 border rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" id="close-appointment" class="btn-secondary text-white py-2 px-4 rounded-lg text-sm">Cancelar</button>
                        <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg text-sm">Guardar cita</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script id="app-script">
        document.addEventListener('DOMContentLoaded', () => {
            const registrationForm = document.getElementById('registration-form');
            const dashboard = document.getElementById('dashboard');
            const vehicleSelector = document.getElementById('vehicle-selector');
            const vehicleForm = document.getElementById('vehicle-form');
            const newMileageForm = document.getElementById('new-mileage-form');
            const maintenanceModal = document.getElementById('maintenance-modal');
            const closeModal = document.getElementById('close-modal');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettings = document.getElementById('close-settings');
            const resetApp = document.getElementById('reset-app');
            const deleteVehicle = document.getElementById('delete-vehicle');
            const addVehicleBtn = document.getElementById('add-vehicle-btn');
            const vehiclesList = document.getElementById('vehicles-list');
            const appointmentModal = document.getElementById('appointment-modal');
            const appointmentForm = document.getElementById('appointment-form');
            const closeAppointment = document.getElementById('close-appointment');
            const newAppointmentBtn = document.getElementById('new-appointment-btn');
            const newAppointmentBtnSecondary = document.getElementById('new-appointment-btn-secondary');
            const authModal = document.getElementById('auth-modal');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            const sessionInfo = document.getElementById('session-info');
            const logoutBtn = document.getElementById('logout-btn');

            initializeAuthThenApp();

            vehicleForm.addEventListener('submit', handleVehicleRegistration);
            newMileageForm.addEventListener('submit', handleMileageUpdate);
            closeModal.addEventListener('click', () => maintenanceModal.classList.add('hidden'));
            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
            resetApp.addEventListener('click', resetApplication);
            deleteVehicle.addEventListener('click', deleteCurrentVehicle);
            addVehicleBtn.addEventListener('click', showRegistrationForm);
            if (newAppointmentBtn) newAppointmentBtn.addEventListener('click', () => appointmentModal.classList.remove('hidden'));
            if (newAppointmentBtnSecondary) newAppointmentBtnSecondary.addEventListener('click', () => appointmentModal.classList.remove('hidden'));
            if (closeAppointment) closeAppointment.addEventListener('click', () => appointmentModal.classList.add('hidden'));
            if (appointmentForm) appointmentForm.addEventListener('submit', handleAppointmentCreate);
            if (tabLogin) tabLogin.addEventListener('click', () => switchAuthTab('login'));
            if (tabRegister) tabRegister.addEventListener('click', () => switchAuthTab('register'));
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (registerForm) registerForm.addEventListener('submit', handleRegister);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            // --- Auth helpers & namespacing ---
            function currentUserId() { return localStorage.getItem('carTrackerCurrentUser'); }
            function setCurrentUser(id) { localStorage.setItem('carTrackerCurrentUser', id); }
            function userKey(suffix) { const uid = currentUserId(); return `carTracker:${uid}:${suffix}`; }
            function loadUsers() { return JSON.parse(localStorage.getItem('carTrackerUsers') || '[]'); }
            function saveUsers(users) { localStorage.setItem('carTrackerUsers', JSON.stringify(users)); }

            function initializeAuthThenApp() {
                const uid = currentUserId();
                if (!uid) {
                    authModal.classList.remove('hidden');
                    registrationForm.classList.add('hidden');
                    dashboard.classList.add('hidden');
                    vehicleSelector.classList.add('hidden');
                } else {
                    updateSessionInfo();
                    initializeApp();
                }
            }

            function switchAuthTab(which) {
                if (which === 'login') {
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    tabLogin.classList.add('bg-gray-200');
                    tabRegister.classList.remove('bg-gray-200');
                } else {
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    tabRegister.classList.add('bg-gray-200');
                    tabLogin.classList.remove('bg-gray-200');
                }
            }

            function handleRegister(e) {
                e.preventDefault();
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim().toLowerCase();
                const password = document.getElementById('reg-password').value;
                const users = loadUsers();
                const exists = users.some(u => u.email === email);
                const err = document.getElementById('register-error');
                if (exists) { err.classList.remove('hidden'); return; }
                err.classList.add('hidden');
                const uid = `u_${Date.now()}`;
                users.push({ id: uid, name, email, password });
                saveUsers(users);
                setCurrentUser(uid);
                migrateLegacyDataIfAny(uid);
                authModal.classList.add('hidden');
                updateSessionInfo();
                initializeApp();
            }

            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const password = document.getElementById('login-password').value;
                const users = loadUsers();
                const user = users.find(u => u.email === email && u.password === password);
                const err = document.getElementById('login-error');
                if (!user) { err.classList.remove('hidden'); return; }
                err.classList.add('hidden');
                setCurrentUser(user.id);
                migrateLegacyDataIfAny(user.id);
                authModal.classList.add('hidden');
                updateSessionInfo();
                initializeApp();
            }

            function handleLogout() {
                localStorage.removeItem('carTrackerCurrentUser');
                authModal.classList.remove('hidden');
                registrationForm.classList.add('hidden');
                dashboard.classList.add('hidden');
                vehicleSelector.classList.add('hidden');
                sessionInfo.classList.add('hidden');
            }

            function updateSessionInfo() {
                const users = loadUsers();
                const uid = currentUserId();
                const u = users.find(x => x.id === uid);
                if (u) {
                    sessionInfo.textContent = `Sesión: ${u.name} • ${u.email}`;
                    sessionInfo.classList.remove('hidden');
                }
            }

            function migrateLegacyDataIfAny(uid) {
                try {
                    const legacyVehicles = localStorage.getItem('carTrackerVehicles');
                    const legacyCurrent = localStorage.getItem('carTrackerCurrentVehicle');
                    const nsVehiclesKey = `carTracker:${uid}:vehicles`;
                    const nsCurrentKey = `carTracker:${uid}:currentVehicle`;
                    if (legacyVehicles && !localStorage.getItem(nsVehiclesKey)) localStorage.setItem(nsVehiclesKey, legacyVehicles);
                    if (legacyCurrent && !localStorage.getItem(nsCurrentKey)) localStorage.setItem(nsCurrentKey, legacyCurrent);
                } catch (e) {}
            }

            function loadVehicles() {
                const key = userKey('vehicles');
                return JSON.parse(localStorage.getItem(key) || '[]');
            }

            // --- Appointments ---
            function renderAppointments(appointments = []) {
                const container = document.getElementById('appointments-list');
                if (!container) return;
                container.innerHTML = '';
                if (!appointments.length) {
                    const p = document.createElement('p');
                    p.className = 'text-gray-500 text-center py-4';
                    p.textContent = 'No hay citas programadas';
                    container.appendChild(p);
                    return;
                }
                const sorted = [...appointments].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
                sorted.forEach((appt, idx) => {
                    const d = new Date(appt.dateTime);
                    const dateStr = d.toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
                    const row = document.createElement('div');
                    row.className = 'p-4 bg-gray-50 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between gap-3';
                    row.innerHTML = `
                        <div>
                            <div class="font-semibold ${appt.status === 'done' ? 'line-through text-gray-400' : ''}">${appt.workshop} • ${dateStr}</div>
                            ${appt.notes ? `<div class="text-sm text-gray-600">${appt.notes}</div>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button data-action="toggle" data-id="${appt.id}" class="text-sm px-3 py-2 rounded ${appt.status==='done' ? 'btn-secondary text-white' : 'btn-primary text-white'}">
                                ${appt.status==='done' ? '<i class="fas fa-rotate-left mr-1"></i>Reabrir' : '<i class="fas fa-check mr-1"></i>Completar'}
                            </button>
                            <button data-action="delete" data-id="${appt.id}" class="text-sm px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(row);
                });

                // attach actions
                container.querySelectorAll('button[data-action]').forEach(btn => {
                    const id = btn.getAttribute('data-id');
                    const action = btn.getAttribute('data-action');
                    btn.addEventListener('click', () => handleAppointmentAction(action, id));
                });
            }

            function handleAppointmentCreate(e) {
                e.preventDefault();
                const date = (document.getElementById('appt-date') || {}).value;
                const time = (document.getElementById('appt-time') || {}).value;
                const workshop = (document.getElementById('appt-workshop') || {}).value?.trim();
                const notes = (document.getElementById('appt-notes') || {}).value?.trim();
                if (!date || !time || !workshop) return;
                const dateTime = new Date(`${date}T${time}:00`).toISOString();
                const vehicles = loadVehicles();
                const current = getCurrentVehicle();
                if (!current) return;
                const idx = vehicles.findIndex(v => v.id === current.id);
                if (idx < 0) return;
                const appt = { id: Date.now().toString(), dateTime, workshop, notes, status: 'scheduled', createdAt: new Date().toISOString() };
                vehicles[idx].appointments = vehicles[idx].appointments || [];
                vehicles[idx].appointments.push(appt);
                saveVehicles(vehicles);
                renderAppointments(vehicles[idx].appointments);
                appointmentForm.reset();
                appointmentModal.classList.add('hidden');
            }

            function handleAppointmentAction(action, apptId) {
                const vehicles = loadVehicles();
                const current = getCurrentVehicle();
                if (!current) return;
                const idx = vehicles.findIndex(v => v.id === current.id);
                if (idx < 0) return;
                const list = vehicles[idx].appointments || [];
                const i = list.findIndex(a => a.id === apptId);
                if (i < 0) return;
                if (action === 'delete') {
                    list.splice(i,1);
                } else if (action === 'toggle') {
                    list[i].status = list[i].status === 'done' ? 'scheduled' : 'done';
                }
                vehicles[idx].appointments = list;
                saveVehicles(vehicles);
                renderAppointments(list);
            }
            function saveVehicles(vehicles) {
                const key = userKey('vehicles');
                localStorage.setItem(key, JSON.stringify(vehicles));
            }
            function loadCurrentVehicleId() {
                const key = userKey('currentVehicle');
                return localStorage.getItem(key);
            }
            function saveCurrentVehicleId(id) {
                const key = userKey('currentVehicle');
                localStorage.setItem(key, id);
            }
            function getCurrentVehicle() {
                const vehicles = loadVehicles();
                const currentId = loadCurrentVehicleId();
                return vehicles.find(v => v.id === currentId) || null;
            }

            function initializeApp() {
                const vehicles = loadVehicles();
                if (vehicles.length > 0) {
                    let currentVehicle = getCurrentVehicle();
                    if (!currentVehicle) {
                        saveCurrentVehicleId(vehicles[0].id);
                        currentVehicle = vehicles[0];
                    }
                    updateVehiclesList();
                    displayDashboard(currentVehicle);
                    vehicleSelector.classList.remove('hidden');
                    dashboard.classList.remove('hidden');
                    registrationForm.classList.add('hidden');
                } else {
                    vehicleSelector.classList.add('hidden');
                    dashboard.classList.add('hidden');
                    registrationForm.classList.remove('hidden');
                }
            }

            function updateVehiclesList() {
                const vehicles = loadVehicles();
                const currentVehicleId = loadCurrentVehicleId();
                vehiclesList.innerHTML = '';
                if (vehicles.length === 0) {
                    const empty = document.createElement('p');
                    empty.className = 'text-gray-500 text-center py-4 col-span-2';
                    empty.textContent = 'No hay vehículos registrados aún';
                    vehiclesList.appendChild(empty);
                    return;
                }
                vehicles.forEach(vehicle => {
                    const vehicleCard = document.createElement('div');
                    vehicleCard.className = `p-4 rounded-lg cursor-pointer border-2 ${vehicle.id === currentVehicleId ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`;
                    vehicleCard.dataset.vehicleId = vehicle.id;
                    const lastMileageRecord = vehicle.mileageRecords[vehicle.mileageRecords.length - 1];
                    vehicleCard.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="license-plate">${vehicle.profile.licensePlate}</span>
                                <div class="mt-2 font-semibold">${vehicle.profile.model} ${vehicle.profile.year}</div>
                                <div class="text-sm text-gray-600">${lastMileageRecord.mileage.toLocaleString()} km</div>
                            </div>
                            <div>
                                ${vehicle.id === currentVehicleId ? '<span class="text-red-500"><i class="fas fa-check-circle"></i></span>' : ''}
                            </div>
                        </div>
                    `;
                    vehicleCard.addEventListener('click', () => selectVehicle(vehicle.id));
                    vehiclesList.appendChild(vehicleCard);
                });
            }

            function selectVehicle(vehicleId) {
                const vehicles = loadVehicles();
                const selectedVehicle = vehicles.find(v => v.id === vehicleId);
                if (selectedVehicle) {
                    saveCurrentVehicleId(vehicleId);
                    updateVehiclesList();
                    displayDashboard(selectedVehicle);
                }
            }

            function showRegistrationForm() {
                vehicleForm.reset();
                ['name','idNumber','model','year','licensePlate','initialMileage'].forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.remove('input-error','input-warning','shake');
                    const err = document.getElementById(`${id}-error`);
                    if (err) err.classList.add('hidden');
                });
                // Prefill owner name from current session and keep it disabled
                try {
                    const users = loadUsers();
                    const uid = currentUserId();
                    const u = users.find(x => x.id === uid);
                    if (u) {
                        const nameInput = document.getElementById('name');
                        if (nameInput) nameInput.value = u.name;
                    }
                } catch (e) {}
                registrationForm.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }

            function displayDashboard(vehicle) {
                dashboard.classList.remove('hidden');
                registrationForm.classList.add('hidden');
                document.getElementById('dashboard-name').textContent = vehicle.profile.name;
                document.getElementById('dashboard-model-year').textContent = `${vehicle.profile.model} ${vehicle.profile.year}`;
                document.getElementById('dashboard-license-plate').textContent = vehicle.profile.licensePlate;
                const lastMileageRecord = vehicle.mileageRecords[vehicle.mileageRecords.length - 1];
                document.getElementById('current-mileage').textContent = `${lastMileageRecord.mileage.toLocaleString()} km`;
                updateMileageHistory(vehicle.mileageRecords);
                renderAppointments(vehicle.appointments);
            }

            function handleVehicleRegistration(e) {
                e.preventDefault();
                const submitBtn = vehicleForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                document.getElementById('submit-text').textContent = 'Guardando...';
                document.getElementById('loading-spinner').classList.remove('hidden');
                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                const yearValue = parseInt(document.getElementById('year').value, 10);
                const formData = {
                    name: (function(){
                        const users = loadUsers();
                        const uid = currentUserId();
                        const u = users.find(x => x.id === uid);
                        return u ? u.name : (document.getElementById('name').value || '').trim();
                    })(),
                    idNumber: document.getElementById('idNumber').value.trim(),
                    model: document.getElementById('model').value.trim(),
                    year: yearValue,
                    licensePlate: document.getElementById('licensePlate').value.trim().toUpperCase(),
                    initialMileage: parseInt(document.getElementById('initialMileage').value, 10)
                };
                let isValid = true;
                // Name comes from the logged-in user; no manual validation needed
                if (!formData.idNumber) { showError('idNumber', 'La cédula es requerida'); isValid = false; }
                if (!formData.model) { showError('model', 'El modelo es requerido'); isValid = false; }
                if (isNaN(formData.year) || formData.year < 1900 || formData.year > 2025) { showError('year', 'Ingrese un año válido (1900-2025)'); isValid = false; }
                if (!formData.licensePlate || !/^[A-Z0-9]+$/.test(formData.licensePlate)) { showError('licensePlate', 'Ingrese una placa válida (sólo letras y números)'); isValid = false; }
                if (isNaN(formData.initialMileage) || formData.initialMileage < 0) { showError('initialMileage', 'Ingrese un kilometraje válido'); isValid = false; }
                if (!isValid) {
                    submitBtn.disabled = false;
                    document.getElementById('submit-text').textContent = 'Guardar y Continuar';
                    document.getElementById('loading-spinner').classList.add('hidden');
                    return;
                }
                setTimeout(() => {
                    const newVehicle = {
                        id: Date.now().toString(),
                        profile: {
                            name: formData.name,
                            idNumber: formData.idNumber,
                            model: formData.model,
                            year: formData.year,
                            licensePlate: formData.licensePlate
                        },
                        mileageRecords: [
                            { mileage: formData.initialMileage, timestamp: new Date().toISOString(), isMaintenance: false }
                        ],
                        appointments: []
                    };
                    const vehicles = loadVehicles();
                    vehicles.push(newVehicle);
                    saveVehicles(vehicles);
                    saveCurrentVehicleId(newVehicle.id);
                    vehicleSelector.classList.remove('hidden');
                    updateVehiclesList();
                    displayDashboard(newVehicle);
                    vehicleForm.reset();
                    submitBtn.disabled = false;
                    document.getElementById('submit-text').textContent = 'Guardar y Continuar';
                    document.getElementById('loading-spinner').classList.add('hidden');
                }, 1000);
            }

            function handleMileageUpdate(e) {
                e.preventDefault();
                const submitBtn = newMileageForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                document.getElementById('update-spinner').classList.remove('hidden');
                document.getElementById('newMileage-error').classList.add('hidden');
                document.getElementById('newMileage-warning').classList.add('hidden');
                document.getElementById('newMileage').classList.remove('input-error', 'input-warning');
                const newMileageInput = document.getElementById('newMileage');
                const newMileage = parseInt(newMileageInput.value, 10);
                const currentVehicle = getCurrentVehicle();
                if (!currentVehicle) return;
                const lastMileageRecord = currentVehicle.mileageRecords[currentVehicle.mileageRecords.length - 1];
                if (isNaN(newMileage) || newMileage < 0) {
                    document.getElementById('newMileage-error').textContent = 'Ingrese un kilometraje válido';
                    document.getElementById('newMileage-error').classList.remove('hidden');
                    document.getElementById('newMileage').classList.add('input-error', 'shake');
                    submitBtn.disabled = false;
                    document.getElementById('update-spinner').classList.add('hidden');
                    setTimeout(() => { document.getElementById('newMileage').classList.remove('shake'); }, 500);
                    return;
                }
                if (newMileage < lastMileageRecord.mileage) {
                    document.getElementById('newMileage-warning').classList.remove('hidden');
                    document.getElementById('newMileage').classList.add('input-warning');
                }
                setTimeout(() => {
                    const currentHighestMileage = Math.max(...currentVehicle.mileageRecords.map(record => record.mileage));
                    const lastMaintenanceBoundary = Math.floor(currentHighestMileage / 5000) * 5000;
                    const newMaintenanceBoundary = Math.floor(newMileage / 5000) * 5000;
                    const isMaintenance = newMaintenanceBoundary > lastMaintenanceBoundary;
                    const newRecord = { mileage: newMileage, timestamp: new Date().toISOString(), isMaintenance };
                    const vehicles = loadVehicles();
                    const vehicleIndex = vehicles.findIndex(v => v.id === currentVehicle.id);
                    if (vehicleIndex >= 0) {
                        vehicles[vehicleIndex].mileageRecords.push(newRecord);
                        saveVehicles(vehicles);
                        document.getElementById('current-mileage').textContent = `${newMileage.toLocaleString()} km`;
                        updateMileageHistory(vehicles[vehicleIndex].mileageRecords);
                        updateVehiclesList();
                        renderAppointments(vehicles[vehicleIndex].appointments || []);
                        if (isMaintenance) {
                            maintenanceModal.classList.remove('hidden');
                            document.getElementById('maintenance-message').textContent = `¡Felicidades! Tu vehículo ha superado el hito de ${newMaintenanceBoundary} km. Es momento de realizar la revisión periódica de 5000 km.`;
                        }
                    }
                    newMileageForm.reset();
                    submitBtn.disabled = false;
                    document.getElementById('update-spinner').classList.add('hidden');
                }, 1000);
            }

            function deleteCurrentVehicle() {
                const currentId = loadCurrentVehicleId();
                if (!currentId) return;
                if (confirm('¿Estás seguro de eliminar este vehículo? Sus datos serán borrados.')) {
                    let vehicles = loadVehicles();
                    vehicles = vehicles.filter(v => v.id !== currentId);
                    saveVehicles(vehicles);
                    // remove namespaced current vehicle key
                    const key = userKey('currentVehicle');
                    localStorage.removeItem(key);
                    settingsModal.classList.add('hidden');
                    initializeApp();
                }
            }

            function resetApplication() {
                if (confirm('¿Estás seguro de reiniciar la aplicación? Todos los datos serán borrados.')) {
                    const keyVehicles = userKey('vehicles');
                    const keyCurrent = userKey('currentVehicle');
                    localStorage.removeItem(keyVehicles);
                    localStorage.removeItem(keyCurrent);
                    settingsModal.classList.add('hidden');
                    dashboard.classList.add('hidden');
                    vehicleSelector.classList.add('hidden');
                    registrationForm.classList.remove('hidden');
                    vehicleForm.reset();
                    newMileageForm.reset();
                }
            }

            function updateMileageHistory(mileageRecords) {
                const historyContainer = document.getElementById('maintenance-history');
                historyContainer.innerHTML = '';
                if (!mileageRecords || mileageRecords.length === 0) {
                    const empty = document.createElement('p');
                    empty.className = 'text-gray-500 text-center py-4';
                    empty.textContent = 'No hay registros de mantenimiento aún';
                    historyContainer.appendChild(empty);
                    return;
                }
                const sortedRecords = [...mileageRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                sortedRecords.forEach((record, index) => {
                    const date = new Date(record.timestamp);
                    const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const prevRecord = sortedRecords[index + 1];
                    const kmDelta = prevRecord ? record.mileage - prevRecord.mileage : 0;
                    const recordElement = document.createElement('div');
                    recordElement.className = `p-4 bg-gray-50 rounded-lg flex items-center justify-between ${record.isMaintenance ? 'maintenance-alert' : ''}`;
                    recordElement.innerHTML = `
                        <div>
                            <div class="text-sm text-gray-500">${formattedDate}</div>
                            <div class="font-semibold">${record.mileage.toLocaleString()} km</div>
                            ${prevRecord ? `<div class="text-xs text-gray-500">+${kmDelta.toLocaleString()} km recorridos</div>` : `<div class="text-xs text-gray-500">Lectura Inicial</div>`}
                        </div>
                        <div>
                            ${record.isMaintenance ? `<span class="maintenance-badge px-2 py-1 rounded-full text-xs font-medium"><i class="fas fa-wrench maintenance-icon mr-1"></i>Mantenimiento Requerido</span>` : ''}
                        </div>
                    `;
                    historyContainer.appendChild(recordElement);
                });
            }

            function showError(fieldId, message) {
                const errorElement = document.getElementById(`${fieldId}-error`);
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                document.getElementById(fieldId).classList.add('input-error', 'shake');
                setTimeout(() => { document.getElementById(fieldId).classList.remove('shake'); }, 500);
            }
        });
    </script>
</body>
</html>
